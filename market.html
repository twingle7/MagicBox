<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‚¡ç¥¨è¡Œæƒ… - MagicBox</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow-x: hidden;
    }

    .main-container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      width: 100%;
    }

    h1 {
      font-size: 2.5rem;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 10px rgba(108, 92, 231, 0.3);
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1rem;
      color: #a29bfe;
    }

    /* è´¦æˆ·ä¿¡æ¯é¢æ¿æ ·å¼ */
    .account-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 320px;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .account-toggle {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .account-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }

    .account-toggle .account-title {
      font-size: 1.3rem;
      color: #a29bfe;
      font-weight: 600;
    }

    .toggle-icon {
      font-size: 1.2rem;
      transition: transform 0.3s ease;
    }

    .account-toggle.expanded .toggle-icon {
      transform: rotate(180deg);
    }

    .account-content {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 0 0 15px 15px;
      padding: 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-top: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-height: 0;
      overflow: hidden;
      transition: all 0.5s ease;
    }

    .account-content.expanded {
      padding: 20px;
      max-height: 500px;
    }

    .account-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .info-line:last-child {
      margin-bottom: 0;
    }

    .info-label {
      color: #a29bfe;
    }

    .info-value {
      font-weight: 600;
      color: #fdcb6e;
    }

    .exchange-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .exchange-title {
      font-size: 1.1rem;
      color: #a29bfe;
      margin-bottom: 10px;
      text-align: center;
    }

    .exchange-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .exchange-input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .exchange-input:focus {
      outline: none;
      border-color: #6c5ce7;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.3);
    }

    .exchange-btn {
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .exchange-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
    }

    .exchange-btn:disabled {
      background: #636e72;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .exchange-btn.coin-to-money {
      background: linear-gradient(45deg, #00b894, #55efc4);
    }

    .exchange-btn.money-to-coin {
      background: linear-gradient(45deg, #e17055, #fab1a0);
    }

    .account-buttons {
      display: flex;
      gap: 10px;
    }

    .account-btn {
      flex: 1;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .account-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
    }

    .account-btn:disabled {
      background: #636e72;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .account-btn.register {
      background: linear-gradient(45deg, #00b894, #55efc4);
      width: 100%;
    }

    .result-message {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      margin-top: 10px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.5s ease;
    }

    .result-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .result-message.success {
      background: rgba(0, 184, 148, 0.2);
      border: 1px solid #00b894;
      color: #00b894;
    }

    .result-message.error {
      background: rgba(225, 112, 85, 0.2);
      border: 1px solid #e17055;
      color: #e17055;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .stock-container {
      width: 90%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 40px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .refresh-btn {
      padding: 12px 25px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
    }

    .refresh-btn:active {
      transform: translateY(0);
    }

    .refresh-btn:disabled {
      background: #636e72;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .stock-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .stock-table th {
      background: rgba(108, 92, 231, 0.3);
      padding: 15px 10px;
      text-align: center;
      font-weight: 600;
      color: #a29bfe;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stock-table td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.3s ease;
    }

    .stock-table tr {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .stock-table tr:hover td {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.01);
    }

    .stock-table tr:last-child td {
      border-bottom: none;
    }

    .up {
      color: #00b894;
      font-weight: 600;
    }

    .down {
      color: #e17055;
      font-weight: 600;
    }

    .stock-price {
      font-weight: 600;
      color: #fdcb6e;
    }

    .stock-id {
      font-weight: 600;
      color: #a29bfe;
    }

    .stock-name {
      font-weight: 500;
    }

    .update-time {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85rem;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #a29bfe;
      font-size: 1.1rem;
    }

    .error {
      text-align: center;
      padding: 40px;
      background: rgba(225, 112, 85, 0.2);
      border: 1px solid #e17055;
      border-radius: 10px;
      color: #e17055;
      font-weight: 500;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: #a29bfe;
    }

    /* ä¹°å…¥å¼¹çª—æ ·å¼ */
    .buy-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .buy-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .buy-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      padding: 30px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(30px);
      transition: all 0.3s ease;
      position: relative;
    }

    .buy-modal.active .buy-content {
      transform: translateY(0);
    }

    .buy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .buy-title {
      font-size: 1.5rem;
      color: #a29bfe;
      font-weight: 600;
    }

    .close-buy-btn {
      background: none;
      border: none;
      color: #a29bfe;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-buy-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e17055;
    }

    .buy-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .buy-input {
      padding: 12px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .buy-input:focus {
      outline: none;
      border-color: #6c5ce7;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.3);
    }

    .buy-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .buy-confirm-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(45deg, #00b894, #55efc4);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .buy-confirm-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .buy-confirm-btn:disabled {
      background: #636e72;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .buy-cancel-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(45deg, #e17055, #fab1a0);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .buy-cancel-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* æŒä»“ä¿¡æ¯å¼¹çª—æ ·å¼ */
    .position-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .position-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .position-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(30px);
      transition: all 0.3s ease;
      position: relative;
    }

    .position-modal.active .position-content {
      transform: translateY(0);
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .position-title {
      font-size: 1.5rem;
      color: #a29bfe;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      color: #a29bfe;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e17055;
    }

    .stock-basic-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .position-details {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .position-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .position-line:last-child {
      margin-bottom: 0;
    }

    .position-label {
      color: #a29bfe;
    }

    .position-value {
      font-weight: 600;
      color: #fdcb6e;
    }

    .profit-positive {
      color: #00b894;
    }

    .profit-negative {
      color: #e17055;
    }

    .position-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .position-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .position-btn.buy {
      background: linear-gradient(45deg, #00b894, #55efc4);
    }

    .position-btn.sell {
      background: linear-gradient(45deg, #e17055, #fab1a0);
    }

    .position-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* åº•éƒ¨æŒ‰é’® */
    .bottom-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      width: 100%;
    }

    .back-to-game {
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .back-to-game:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(108, 92, 231, 0.5);
    }

    /* é¢„æµ‹æ¯”èµ›æŒ‰é’® */
    .prediction-btn {
      position: fixed;
      bottom: 30px;
      left: 30px;
      padding: 15px 25px;
      border-radius: 50px;
      border: none;
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      z-index: 100;
      /*box-shadow: 0 0 20px rgba(255, 107, 107, 0.7);
      animation: flame 1.5s infinite alternate;*/
    }

    .prediction-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 0 30px rgba(255, 107, 107, 0.9);
      animation: none;
    }

    @keyframes flame {
      0% {
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.7),
          0 0 25px rgba(255, 107, 107, 0.5),
          0 0 35px rgba(255, 107, 107, 0.3);
      }

      100% {
        box-shadow: 0 0 25px rgba(255, 107, 107, 0.9),
          0 0 35px rgba(255, 107, 107, 0.7),
          0 0 45px rgba(255, 107, 107, 0.5);
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .account-panel {
        position: static;
        width: 100%;
        margin-bottom: 20px;
      }

      .stock-container {
        width: 95%;
        padding: 20px;
      }

      h1 {
        font-size: 2rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .refresh-btn {
        width: 100%;
        justify-content: center;
      }

      .stock-table {
        font-size: 0.9rem;
      }

      .stock-table th,
      .stock-table td {
        padding: 10px 5px;
      }

      .position-content {
        width: 95%;
        padding: 20px;
      }

      .position-actions {
        flex-direction: column;
      }

      .buy-content {
        width: 95%;
        padding: 20px;
      }

      .buy-actions {
        flex-direction: column;
      }

      .prediction-btn {
        bottom: 20px;
        left: 20px;
        padding: 12px 20px;
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .account-panel {
        padding: 0;
      }

      .account-toggle {
        padding: 12px 15px;
      }

      .stock-container {
        width: 100%;
        padding: 15px;
      }

      h1 {
        font-size: 1.8rem;
      }

      .stock-table {
        font-size: 0.8rem;
      }

      .stock-table th,
      .stock-table td {
        padding: 8px 3px;
      }

      .update-time {
        font-size: 0.75rem;
      }

      .position-content {
        padding: 15px;
      }

      .position-title {
        font-size: 1.3rem;
      }

      .position-line {
        font-size: 0.9rem;
      }

      .buy-content {
        padding: 15px;
      }

      .buy-title {
        font-size: 1.3rem;
      }

      .prediction-btn {
        bottom: 15px;
        left: 15px;
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }

    /* è¡¨æ ¼åº•éƒ¨å®¹å™¨ */
    .table-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      width: 100%;
    }

    /* äº¤æ˜“è®°å½•æŒ‰é’®æ ·å¼ */
    .trade-history-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(45deg, #0984e3, #74b9ff);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .trade-history-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(9, 132, 227, 0.4);
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
      .table-footer {
        justify-content: center;
      }

      .trade-history-btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <!-- è´¦æˆ·ä¿¡æ¯é¢æ¿ -->
  <div class="account-panel" id="accountPanel">
    <div class="account-toggle" id="accountToggle">
      <div class="account-title">ğŸ’° è´¦æˆ·ä¿¡æ¯</div>
      <div class="toggle-icon">â–¼</div>
    </div>
    <div class="account-content" id="accountContent">
      <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="result-message" id="accountResult"></div>
  </div>

  <div class="main-container">
    <div class="header">
      <h1>äº¤æ˜“å¤§å…</h1>
      <div class="subtitle">æ¯ä¸¤å°æ—¶è‚¡ä»·åˆ·æ–°ï¼Œä»…æ”¯æŒæ•´æ‰¹æ¬¡å–å‡ºï¼Œå–å‡ºè‚¡ç¥¨è¯·è½¬åˆ°è‚¡ç¥¨äº¤æ˜“è®°å½•é¡µ</div>
    </div>

    <div class="stock-container">
      <div class="controls">
        <button id="refreshBtn" class="refresh-btn">
          <span>ğŸ”„ åˆ·æ–°è¡Œæƒ…</span>
        </button>
        <div class="last-update" id="lastUpdate">æœ€åæ›´æ–°: --</div>
      </div>

      <div id="stockWrap" class="loading">
        <div class="spinner"></div> åŠ è½½è‚¡ç¥¨è¡Œæƒ…ä¸­...
      </div>

      <!-- æ·»åŠ äº¤æ˜“è®°å½•æŒ‰é’®å®¹å™¨ -->
      <div class="table-footer">
        <a href="trade_history.html" class="trade-history-btn">ğŸ“œ äº¤æ˜“è®°å½•</a>
      </div>
    </div>

    <div class="bottom-buttons">
      <a href="game.html" class="back-to-game">ğŸ® è¿”å›æ¸¸æˆ</a>
    </div>
  </div>

  <!-- ä¹°å…¥å¼¹çª— -->
  <div class="buy-modal" id="buyModal">
    <div class="buy-content">
      <div class="buy-header">
        <div class="buy-title">ä¹°å…¥è‚¡ç¥¨</div>
        <button class="close-buy-btn" id="closeBuyModal">Ã—</button>
      </div>
      <div class="buy-form">
        <div class="position-line">
          <span class="position-label">è‚¡ç¥¨ä»£ç :</span>
          <span class="position-value" id="buyStockId"></span>
        </div>
        <div class="position-line">
          <span class="position-label">è‚¡ç¥¨åç§°:</span>
          <span class="position-value" id="buyStockName"></span>
        </div>
        <div class="position-line">
          <span class="position-label">å½“å‰ä»·æ ¼:</span>
          <span class="position-value" id="buyStockPrice"></span>
        </div>
        <input type="number" id="buyQuantity" class="buy-input" placeholder="è¯·è¾“å…¥ä¹°å…¥è‚¡æ•°ï¼ˆæ•´æ•°ï¼‰" min="1" step="1">
        <div class="position-line">
          <span class="position-label">é¢„è®¡æ€»èŠ±è´¹:</span>
          <span class="position-value" id="buyTotalCost">0.00 å…ƒ</span>
        </div>
      </div>
      <div class="buy-actions">
        <button class="buy-confirm-btn" id="confirmBuyBtn">ç¡®è®¤ä¹°å…¥</button>
        <button class="buy-cancel-btn" id="cancelBuyBtn">å–æ¶ˆ</button>
      </div>
      <div class="result-message" id="buyResult"></div>
    </div>
  </div>

  <!-- æŒä»“ä¿¡æ¯å¼¹çª— -->
  <div class="position-modal" id="positionModal">
    <div class="position-content">
      <div class="position-header">
        <div class="position-title">æŒä»“ä¿¡æ¯</div>
        <button class="close-btn" id="closePositionModal">Ã—</button>
      </div>
      <div id="positionContent">
        <!-- æŒä»“ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="position-actions">
        <button class="position-btn buy" id="buyBtn">ä¹°å…¥</button>
        <!--
        <button class="position-btn sell" id="sellBtn">å–å‡º</button>
        -->
      </div>
    </div>
  </div>

  <a href="game-prediction.html" class="prediction-btn">ğŸ”¥ é¢„æµ‹æ¯”èµ›</a>

  <script>
    // ä½¿ç”¨DOMContentLoadedç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
      // DOMå…ƒç´ è·å–å‡½æ•°
      const $ = id => document.getElementById(id);

      // è·å–DOMå…ƒç´ 
      const wrap = $('stockWrap');
      const refreshBtn = $('refreshBtn');
      const lastUpdate = $('lastUpdate');
      const accountContent = $('accountContent');
      const accountResult = $('accountResult');
      const accountToggle = $('accountToggle');
      const accountPanel = $('accountPanel');
      const positionModal = $('positionModal');
      const positionContent = $('positionContent');
      const closePositionModal = $('closePositionModal');
      const buyBtn = $('buyBtn');
      const sellBtn = $('sellBtn');
      const buyModal = $('buyModal');
      const closeBuyModal = $('closeBuyModal');
      const buyStockId = $('buyStockId');
      const buyStockName = $('buyStockName');
      const buyStockPrice = $('buyStockPrice');
      const buyQuantity = $('buyQuantity');
      const buyTotalCost = $('buyTotalCost');
      const confirmBuyBtn = $('confirmBuyBtn');
      const cancelBuyBtn = $('cancelBuyBtn');
      const buyResult = $('buyResult');

      // APIåŸºç¡€URL
      const BASE_URL = 'http://47.92.231.94:8080';

      // è´¦æˆ·é¢æ¿çŠ¶æ€
      let isAccountExpanded = false;

      // å­˜å‚¨è‚¡ç¥¨åˆ—è¡¨æ•°æ®
      let stockList = [];

      // å½“å‰é€‰ä¸­è‚¡ç¥¨ä¿¡æ¯
      let currentStock = null;

      /* å·¥å…·ï¼šæ—¶é—´æˆ³ â†’ åŒ—äº¬æ—¶é—´å­—ç¬¦ä¸² */
      function fmtTime(ts) {
        const d = new Date(ts * 1000);
        return d.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
      }

      /* å·¥å…·ï¼šä»·æ ¼ åˆ†â†’å…ƒ ä¿ç•™2ä½å°æ•° */
      function fmtPrice(fen) {
        return (fen / 100).toFixed(2);
      }

      /* å·¥å…·ï¼šæ¸²æŸ“æ¶¨è·Œå¹…å¸¦ç®­å¤´+é¢œè‰² */
      function fmtChange(pc) {
        const cls = pc >= 0 ? 'up' : 'down';
        const arrow = pc >= 0 ? 'â–²' : 'â–¼';
        return `<span class="${cls}">${arrow} ${Math.abs(pc * 100).toFixed(4)}%</span>`;
      }

      /* æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•° */
      function showResult(message, isSuccess, target = accountResult) {
        target.classList.remove('success', 'error', 'show');
        target.textContent = message;
        target.classList.add(isSuccess ? 'success' : 'error');

        void target.offsetWidth;
        target.classList.add('show');

        setTimeout(() => {
          target.classList.remove('show');
        }, 8000);
      }

      /* è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€ */
      function setButtonLoading(button, isLoading, originalText) {
        if (isLoading) {
          button.disabled = true;
          button.innerHTML = '<span class="spinner"></span> å¤„ç†ä¸­...';
        } else {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      /* è·å–ç”¨æˆ·IDå’ŒCookie */
      function getUid() {
        return localStorage.getItem('uid');
      }

      function getCookie() {
        return localStorage.getItem('cookie');
      }

      /* APIè°ƒç”¨å‡½æ•° */
      async function apiCall(endpoint, data) {
        try {
          const response = await fetch(`${BASE_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error('APIè°ƒç”¨å¤±è´¥:', error);
          throw error;
        }
      }

      /* åŠ è½½è´¦æˆ·ä¿¡æ¯ */
      async function loadAccountInfo() {
        const cookie = getCookie();
        if (!cookie) {
          renderNoLogin();
          return;
        }

        try {
          const data = await apiCall('/market/account_info', { cookie });

          if (data.success) {
            renderAccountInfo(data.money);
          } else {
            renderRegisterButton();
          }
        } catch (error) {
          showResult('ç½‘ç»œé”™è¯¯ï¼š' + error.message, false);
          renderRegisterButton();
        }
      }

      /* æ¸²æŸ“æœªç™»å½•çŠ¶æ€ */
      function renderNoLogin() {
        accountContent.innerHTML = `
          <div class="account-info">
            <div class="info-line">
              <span class="info-label">çŠ¶æ€:</span>
              <span class="info-value" style="color: #e17055;">æœªç™»å½•</span>
            </div>
          </div>
          <div class="account-buttons">
            <button class="account-btn" id="refreshPageBtn">åˆ·æ–°é¡µé¢</button>
          </div>
        `;
      }

      /* æ¸²æŸ“æ³¨å†ŒæŒ‰é’® */
      function renderRegisterButton() {
        const uid = getUid();
        accountContent.innerHTML = `
          <div class="account-info">
            <div class="info-line">
              <span class="info-label">ç”¨æˆ·ID:</span>
              <span class="info-value">${uid || 'æœªçŸ¥'}</span>
            </div>
            <div class="info-line">
              <span class="info-label">è´¦æˆ·çŠ¶æ€:</span>
              <span class="info-value" style="color: #e17055;">æœªå¼€é€š</span>
            </div>
          </div>
          <button class="account-btn register" id="registerBtn">å¼€é€šäº¤æ˜“è´¦æˆ·</button>
        `;
      }

      /* æ¸²æŸ“è´¦æˆ·ä¿¡æ¯ */
      function renderAccountInfo(money) {
        const uid = getUid();
        accountContent.innerHTML = `
          <div class="account-info">
            <div class="info-line">
              <span class="info-label">ç”¨æˆ·ID:</span>
              <span class="info-value">${uid || 'æœªçŸ¥'}</span>
            </div>
            <div class="info-line">
              <span class="info-label">äº¤æ˜“å¸ä½™é¢:</span>
              <span class="info-value">${money.toFixed(2) || 0}</span>
            </div>
          </div>
          <div class="exchange-section">
            <div class="exchange-title">äº¤æ˜“å¸å…‘æ¢</div>
            <div class="exchange-form">
              <input type="number" id="coinInput" class="exchange-input" placeholder="è¾“å…¥é‡‘å¸æ•°é‡" min="1">
              <button class="exchange-btn coin-to-money" id="coinToMoneyBtn">é‡‘å¸ â†’ äº¤æ˜“å¸</button>
            </div>
            <div class="exchange-form">
              <input type="number" id="moneyInput" class="exchange-input" placeholder="è¾“å…¥äº¤æ˜“å¸æ•°é‡ï¼ˆ100çš„å€æ•°ï¼‰" min="100" step="100">
              <button class="exchange-btn money-to-coin" id="moneyToCoinBtn">äº¤æ˜“å¸ â†’ é‡‘å¸</button>
            </div>
          </div>
          <div class="account-buttons">
            <button class="account-btn" id="refreshAccountBtn">åˆ·æ–°è´¦æˆ·ä¿¡æ¯</button>
          </div>
        `;
      }

      /* æ³¨å†Œè´¦æˆ· */
      async function registerAccount() {
        const cookie = getCookie();
        if (!cookie) {
          showResult('è¯·å…ˆç™»å½•', false);
          return;
        }

        const button = $('registerBtn');
        if (button) {
          setButtonLoading(button, true, 'å¼€é€šäº¤æ˜“è´¦æˆ·');
        }

        try {
          const data = await apiCall('/market/register', { cookie });

          if (data.success) {
            showResult('æ³¨å†ŒæˆåŠŸï¼', true);
            setTimeout(loadAccountInfo, 1000);
          } else {
            showResult('æ³¨å†Œå¤±è´¥', false);
          }
        } catch (error) {
          showResult('ç½‘ç»œé”™è¯¯ï¼š' + error.message, false);
        } finally {
          if (button) {
            setButtonLoading(button, false, 'å¼€é€šäº¤æ˜“è´¦æˆ·');
          }
        }
      }

      /* é‡‘å¸å…‘æ¢äº¤æ˜“å¸ */
      async function coinToMoney() {
        const cookie = getCookie();
        const coinInput = $('coinInput');
        const coins = coinInput ? parseInt(coinInput.value) : 0;

        if (!cookie) {
          showResult('è¯·å…ˆç™»å½•', false);
          return;
        }

        if (!coins || coins <= 0) {
          showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘å¸æ•°é‡', false);
          return;
        }

        const button = $('coinToMoneyBtn');
        if (button) {
          setButtonLoading(button, true, 'é‡‘å¸ â†’ äº¤æ˜“å¸');
        }

        try {
          const data = await apiCall('/market/coin_to_money', { cookie, coins });

          if (data.success) {
            showResult('å…‘æ¢æˆåŠŸï¼', true);
            if (coinInput) coinInput.value = '';
            setTimeout(loadAccountInfo, 1000);
          } else {
            showResult('å…‘æ¢å¤±è´¥', false);
          }
        } catch (error) {
          showResult('ç½‘ç»œé”™è¯¯ï¼š' + error.message, false);
        } finally {
          if (button) {
            setButtonLoading(button, false, 'é‡‘å¸ â†’ äº¤æ˜“å¸');
          }
        }
      }

      /* äº¤æ˜“å¸å…‘æ¢é‡‘å¸ */
      async function moneyToCoin() {
        const cookie = getCookie();
        const moneyInput = $('moneyInput');
        const money = moneyInput ? parseInt(moneyInput.value) : 0;

        if (!cookie) {
          showResult('è¯·å…ˆç™»å½•', false);
          return;
        }

        if (!money || money <= 0 || money % 100 !== 0) {
          showResult('è¯·è¾“å…¥100çš„å€æ•°çš„äº¤æ˜“å¸æ•°é‡', false);
          return;
        }

        const button = $('moneyToCoinBtn');
        if (button) {
          setButtonLoading(button, true, 'äº¤æ˜“å¸ â†’ é‡‘å¸');
        }

        try {
          const data = await apiCall('/market/money_to_coin', { cookie, money });

          if (data.success) {
            showResult('å…‘æ¢æˆåŠŸï¼', true);
            if (moneyInput) moneyInput.value = '';
            setTimeout(loadAccountInfo, 1000);
          } else {
            showResult('å…‘æ¢å¤±è´¥', false);
          }
        } catch (error) {
          showResult('ç½‘ç»œé”™è¯¯ï¼š' + error.message, false);
        } finally {
          if (button) {
            setButtonLoading(button, false, 'äº¤æ˜“å¸ â†’ é‡‘å¸');
          }
        }
      }

      /* è‚¡ç¥¨è¡Œæƒ…ç›¸å…³å‡½æ•° */
      async function loadStocks() {
        if (wrap) {
          wrap.className = 'loading';
          wrap.innerHTML = '<div class="spinner"></div> åŠ è½½è‚¡ç¥¨è¡Œæƒ…ä¸­...';
        }

        if (refreshBtn) {
          setButtonLoading(refreshBtn, true, 'ğŸ”„ åˆ·æ–°è¡Œæƒ…');
        }

        try {
          const res = await fetch('http://47.92.231.94:8080/stock/view');
          const json = await res.json();

          if (!json.success) {
            throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
          }

          // å­˜å‚¨è‚¡ç¥¨åˆ—è¡¨
          stockList = json.stocks || [];

          if (lastUpdate && json.stocks && json.stocks.length > 0) {
            const latestUpdate = Math.max(...json.stocks.map(s => s.last_update));
            lastUpdate.textContent = `æœ€åæ›´æ–°: ${fmtTime(latestUpdate)}`;
          }

          render(json.stocks);
        } catch (e) {
          if (wrap) {
            wrap.className = 'error';
            wrap.innerHTML = `åŠ è½½å¤±è´¥ï¼š${e.message}`;
          }
        } finally {
          if (refreshBtn) {
            setButtonLoading(refreshBtn, false, 'ğŸ”„ åˆ·æ–°è¡Œæƒ…');
          }
        }
      }

      function render(list) {
        if (!wrap) return;

        if (!list || list.length === 0) {
          wrap.className = 'empty';
          wrap.innerHTML = 'æš‚æ— è‚¡ç¥¨æ•°æ®';
          return;
        }

        let html = `<table class="stock-table">
          <thead>
            <tr>
              <th>ä»£ç </th>
              <th>åç§°</th>
              <th>ç°ä»· (å…ƒ)</th>
              <th>æ¶¨è·Œå¹…</th>
              <th>æ›´æ–°æ—¶é—´</th>
            </tr>
          </thead>
          <tbody>`;

        list.forEach((s, index) => {
          html += `<tr data-stock-id="${s.stock_id}" data-index="${index}">
            <td class="stock-id">${s.stock_id}</td>
            <td class="stock-name">${s.stock_name}</td>
            <td class="stock-price">${fmtPrice(s.stock_price)}</td>
            <td>${fmtChange(s.change_percent)}</td>
            <td class="update-time">${fmtTime(s.last_update)}</td>
          </tr>`;
        });

        html += '</tbody></table>';
        wrap.className = '';
        wrap.innerHTML = html;

        // ä¸ºè‚¡ç¥¨è¡Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
        const stockRows = wrap.querySelectorAll('tr[data-stock-id]');
        stockRows.forEach(row => {
          row.addEventListener('click', handleStockClick);
        });
      }

      /* å¤„ç†è‚¡ç¥¨ç‚¹å‡»äº‹ä»¶ */
      async function handleStockClick(event) {
        const row = event.currentTarget;
        const stockId = row.getAttribute('data-stock-id');
        const index = row.getAttribute('data-index');

        // è·å–è‚¡ç¥¨ä¿¡æ¯
        const stock = stockList[index];
        if (!stock) return;

        const cookie = getCookie();
        if (!cookie) {
          showResult('è¯·å…ˆç™»å½•', false);
          return;
        }

        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          positionContent.innerHTML = `
            <div class="loading" style="padding: 40px; text-align: center;">
              <div class="spinner"></div> åŠ è½½æŒä»“ä¿¡æ¯ä¸­...
            </div>
          `;

          // æ˜¾ç¤ºå¼¹çª—
          positionModal.classList.add('active');

          // è°ƒç”¨APIè·å–æŒä»“ä¿¡æ¯
          const data = await apiCall('/stock/view_one', {
            cookie: cookie,
            stock_id: stockId
          });

          if (data.success) {
            renderPositionInfo(data.stock_info, data.position);
          } else {
            renderPositionError(data.error || 'è·å–æŒä»“ä¿¡æ¯å¤±è´¥');
          }
        } catch (error) {
          console.error('è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', error);
          renderPositionError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
        }
      }

      /* æ¸²æŸ“æŒä»“ä¿¡æ¯ */
      function renderPositionInfo(stockInfo, position) {
        const profitClass = position.profit_loss >= 0 ? 'profit-positive' : 'profit-negative';
        const profitSign = position.profit_loss >= 0 ? '+' : '';

        positionContent.innerHTML = `
          <div class="stock-basic-info">
            <div class="position-line">
              <span class="position-label">è‚¡ç¥¨ä»£ç :</span>
              <span class="position-value">${stockInfo.stock_id}</span>
            </div>
            <div class="position-line">
              <span class="position-label">è‚¡ç¥¨åç§°:</span>
              <span class="position-value">${stockInfo.stock_name}</span>
            </div>
            <div class="position-line">
              <span class="position-label">å½“å‰ä»·æ ¼:</span>
              <span class="position-value">${fmtPrice(stockInfo.current_price)} å…ƒ</span>
            </div>
          </div>
          
          <div class="position-details">
            <div class="position-line">
              <span class="position-label">æŒä»“æ•°é‡:</span>
              <span class="position-value">${position.total_quantity} è‚¡</span>
            </div>
            <div class="position-line">
              <span class="position-label">å¯ç”¨æ•°é‡:</span>
              <span class="position-value">${position.available_quantity} è‚¡</span>
            </div>
            <div class="position-line">
              <span class="position-label">å†»ç»“æ•°é‡:</span>
              <span class="position-value">${position.frozen_quantity} è‚¡</span>
            </div>
            <div class="position-line">
              <span class="position-label">å¹³å‡æˆæœ¬:</span>
              <span class="position-value">${position.avg_cost_price} å…ƒ</span>
            </div>
            <div class="position-line">
              <span class="position-label">å½“å‰å¸‚å€¼:</span>
              <span class="position-value">${fmtPrice(position.current_price)} å…ƒ</span>
            </div>
            <div class="position-line">
              <span class="position-label">ç›ˆäºé‡‘é¢:</span>
              <span class="position-value ${profitClass}">${profitSign}${position.profit_loss} å…ƒ</span>
            </div>
            <div class="position-line">
              <span class="position-label">ç›ˆäºæ¯”ä¾‹:</span>
              <span class="position-value ${profitClass}">${profitSign}${position.profit_loss_rate}%</span>
            </div>
          </div>
        `;

        // å­˜å‚¨å½“å‰é€‰ä¸­çš„è‚¡ç¥¨ä¿¡æ¯ï¼Œä¾›ä¹°å…¥å–å‡ºæŒ‰é’®ä½¿ç”¨
        currentStock = {
          stock_id: stockInfo.stock_id,
          stock_name: stockInfo.stock_name,
          current_price: stockInfo.current_price
        };
      }

      /* æ¸²æŸ“æŒä»“é”™è¯¯ä¿¡æ¯ */
      function renderPositionError(errorMessage) {
        positionContent.innerHTML = `
          <div class="error" style="padding: 20px; text-align: center;">
            ${errorMessage}
          </div>
        `;
      }

      /* æ‰“å¼€ä¹°å…¥å¼¹çª— */
      function openBuyModal() {
        if (!currentStock) {
          showResult('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨', false);
          return;
        }

        buyStockId.textContent = currentStock.stock_id;
        buyStockName.textContent = currentStock.stock_name;
        buyStockPrice.textContent = fmtPrice(currentStock.current_price) + ' å…ƒ';
        buyQuantity.value = '';
        buyTotalCost.textContent = '0.00 å…ƒ';
        buyResult.classList.remove('show');

        positionModal.classList.remove('active');
        buyModal.classList.add('active');
      }

      /* å…³é—­ä¹°å…¥å¼¹çª— */
      function closeBuyModalHandler() {
        buyModal.classList.remove('active');
      }

      /* è®¡ç®—é¢„è®¡æ€»èŠ±è´¹ */
      function calculateTotalCost() {
        const quantity = parseInt(buyQuantity.value) || 0;
        const price = currentStock ? currentStock.current_price : 0;
        const totalCost = (quantity * price / 100).toFixed(2);
        buyTotalCost.textContent = totalCost + ' å…ƒ';
      }

      /* ç¡®è®¤ä¹°å…¥ */
      async function confirmBuy() {
        const cookie = getCookie();
        const quantity = parseInt(buyQuantity.value);

        if (!cookie) {
          showResult('è¯·å…ˆç™»å½•', false, buyResult);
          return;
        }

        if (!quantity || quantity <= 0 || !Number.isInteger(quantity)) {
          showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¹°å…¥è‚¡æ•°ï¼ˆæ­£æ•´æ•°ï¼‰', false, buyResult);
          return;
        }

        if (!currentStock) {
          showResult('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨', false, buyResult);
          return;
        }

        setButtonLoading(confirmBuyBtn, true, 'ç¡®è®¤ä¹°å…¥');

        try {
          const data = await apiCall('/stock/buy_one', {
            cookie: cookie,
            stock_id: currentStock.stock_id,
            quantity: quantity
          });

          if (data.success) {
            // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
            showResult(
              `ä¹°å…¥æˆåŠŸï¼\nèŠ±è´¹ ${data.transaction.total_cost.toFixed(2)} å…ƒï¼Œä¹°å…¥ ${data.transaction.quantity} è‚¡\nå¯å–å‡ºæ—¶é—´ï¼š${data.transaction.can_sell_after}`,
              true,
              buyResult
            );

            // æ›´æ–°è´¦æˆ·ä½™é¢æ˜¾ç¤º
            /*const moneyElement = document.querySelector('.info-value');
            if (moneyElement && data.new_balance !== undefined) {
              moneyElement.textContent = data.new_balance;
            }*/

            // å…³é—­å¼¹çª—å¹¶åˆ·æ–°è¡Œæƒ…
            setTimeout(() => {
              closeBuyModalHandler();
              loadStocks();
            }, 8000);
          } else {
            showResult(data.error || 'ä¹°å…¥å¤±è´¥', false, buyResult);
          }
        } catch (error) {
          showResult('ç½‘ç»œé”™è¯¯ï¼š' + error.message, false, buyResult);
        } finally {
          setButtonLoading(confirmBuyBtn, false, 'ç¡®è®¤ä¹°å…¥');
        }
      }

      /* äº‹ä»¶å§”æ‰˜å¤„ç†å‡½æ•° */
      function handleAccountPanelClick(e) {
        const target = e.target;

        if (target.id === 'refreshAccountBtn') {
          loadAccountInfo();
        } else if (target.id === 'coinToMoneyBtn') {
          coinToMoney();
        } else if (target.id === 'moneyToCoinBtn') {
          moneyToCoin();
        } else if (target.id === 'registerBtn') {
          registerAccount();
        } else if (target.id === 'refreshPageBtn') {
          location.reload();
        }
      }

      /* åˆ‡æ¢è´¦æˆ·é¢æ¿å±•å¼€/æ”¶èµ· */
      function toggleAccountPanel() {
        isAccountExpanded = !isAccountExpanded;

        if (isAccountExpanded) {
          accountToggle.classList.add('expanded');
          accountContent.classList.add('expanded');
          loadAccountInfo();
        } else {
          accountToggle.classList.remove('expanded');
          accountContent.classList.remove('expanded');
        }
      }

      /* å…³é—­æŒä»“å¼¹çª— */
      function closePositionModalHandler() {
        positionModal.classList.remove('active');
      }

      /* å–å‡ºæŒ‰é’®ç‚¹å‡»å¤„ç† */
      function handleSellClick() {
        const stockId = positionContent.getAttribute('data-stock-id');
        const stockName = positionContent.getAttribute('data-stock-name');
        const currentPrice = positionContent.getAttribute('data-current-price');

        if (!stockId) {
          showResult('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨', false);
          return;
        }

        // è¿™é‡Œå¯ä»¥æ·»åŠ å–å‡ºé€»è¾‘
        showResult(`å‡†å¤‡å–å‡º ${stockName}(${stockId})ï¼Œå½“å‰ä»·æ ¼ ${fmtPrice(currentPrice)} å…ƒ`, true);
        console.log('å–å‡ºè‚¡ç¥¨:', stockId, stockName, currentPrice);

        // å…³é—­å¼¹çª—
        closePositionModalHandler();
      }

      /* åˆå§‹åŒ– */
      if (refreshBtn) {
        refreshBtn.onclick = loadStocks;
      }

      // ç»‘å®šè´¦æˆ·é¢æ¿åˆ‡æ¢äº‹ä»¶
      if (accountToggle) {
        accountToggle.addEventListener('click', toggleAccountPanel);
      }

      // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šè´¦æˆ·é¢æ¿çš„æ‰€æœ‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      accountContent.addEventListener('click', handleAccountPanelClick);

      // ç»‘å®šæŒä»“å¼¹çª—äº‹ä»¶
      if (closePositionModal) {
        closePositionModal.addEventListener('click', closePositionModalHandler);
      }

      // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
      positionModal.addEventListener('click', function (e) {
        if (e.target === positionModal) {
          closePositionModalHandler();
        }
      });

      // ç»‘å®šä¹°å…¥å–å‡ºæŒ‰é’®äº‹ä»¶
      if (buyBtn) {
        buyBtn.addEventListener('click', openBuyModal);
      }

      if (sellBtn) {
        sellBtn.addEventListener('click', handleSellClick);
      }

      // ç»‘å®šä¹°å…¥å¼¹çª—äº‹ä»¶
      if (closeBuyModal) {
        closeBuyModal.addEventListener('click', closeBuyModalHandler);
      }

      // ç‚¹å‡»ä¹°å…¥å¼¹çª—èƒŒæ™¯å…³é—­
      buyModal.addEventListener('click', function (e) {
        if (e.target === buyModal) {
          closeBuyModalHandler();
        }
      });

      // ç»‘å®šä¹°å…¥æ•°é‡è¾“å…¥äº‹ä»¶
      if (buyQuantity) {
        buyQuantity.addEventListener('input', calculateTotalCost);
      }

      // ç»‘å®šç¡®è®¤ä¹°å…¥æŒ‰é’®
      if (confirmBuyBtn) {
        confirmBuyBtn.addEventListener('click', confirmBuy);
      }

      // ç»‘å®šå–æ¶ˆä¹°å…¥æŒ‰é’®
      if (cancelBuyBtn) {
        cancelBuyBtn.addEventListener('click', closeBuyModalHandler);
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è‚¡ç¥¨è¡Œæƒ…
      loadStocks();

      /* æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ */
      document.addEventListener('keydown', (e) => {
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          loadStocks();
        }

        // ESCé”®å…³é—­å¼¹çª—
        if (e.key === 'Escape') {
          if (buyModal.classList.contains('active')) {
            closeBuyModalHandler();
          } else if (positionModal.classList.contains('active')) {
            closePositionModalHandler();
          }
        }
      });
    });
  </script>
</body>

</html>