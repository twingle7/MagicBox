<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰Œåˆæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #00b894, #00cec9);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 184, 148, 0.3);
            margin-bottom: 10px;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(45deg, #0984e3, #74b9ff);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 100;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(9, 132, 227, 0.4);
        }

        /* åˆæˆæŒ‰é’®åŒºåŸŸ */
        .combine-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .combine-btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            text-align: center;
        }

        .combine-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }

        .combine-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.6);
        }

        /* ç¨€æœ‰åº¦æŒ‰é’®é¢œè‰² */
        .rarity-1 {
            background: linear-gradient(45deg, #f5f5f5, #e0e0e0);
            color: #333;
        }

        .rarity-2 {
            background: linear-gradient(45deg, #00cec9, #81ecec);
        }

        .rarity-3 {
            background: linear-gradient(45deg, #74b9ff, #a8d8ff);
        }

        .rarity-4 {
            background: linear-gradient(45deg, #a29bfe, #c7b9ff);
        }

        .rarity-5 {
            background: linear-gradient(45deg, #fdcb6e, #ffeaa7);
            color: #333;
        }

        .rarity-6 {
            background: linear-gradient(45deg, #ff7675, #fd79a8);
        }

        /* å¡ç‰‡å±•ç¤ºåŒºåŸŸ */
        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .set-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .set-header {
            font-size: 1.3rem;
            color: #00cec9;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .card-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .card-item.selected {
            box-shadow: 0 0 0 3px #00b894;
        }

        .card-image {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
        }

        .card-info {
            padding: 15px;
        }

        .card-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-global-id {
            font-size: 0.9rem;
            color: #aaa;
        }

        /* é€‰æ‹©ç»Ÿè®¡ */
        .selection-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 184, 148, 0.3);
            margin-bottom: 20px;
        }

        .selected-count {
            font-size: 1.2rem;
            color: #00b894;
            font-weight: 600;
        }

        /* åˆæˆæŒ‰é’® */
        .execute-combine-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .execute-combine-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 184, 148, 0.5);
        }

        .execute-combine-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åˆæˆç»“æœæ¨¡æ€æ¡† */
        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .result-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .result-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-modal-title {
            font-size: 2rem;
            color: #00b894;
            margin-bottom: 10px;
        }

        .result-modal-success-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .result-modal-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-info-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .result-info-label {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .result-info-value {
            color: #00b894;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .consumed-cards-section {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .consumed-header {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .consumed-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .consumed-id {
            background: rgba(255, 107, 107, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .result-modal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: rgba(0, 184, 148, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(0, 184, 148, 0.3);
        }

        .result-card-image {
            width: 100%;
            height: 180px;
            background-size: cover;
            background-position: center;
        }

        .result-card-info {
            padding: 15px;
            text-align: center;
        }

        .result-card-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .result-card-id {
            font-size: 0.9rem;
            color: #aaa;
        }

        .result-modal-actions {
            text-align: center;
            margin-top: 30px;
        }

        .modal-close-btn {
            padding: 10px 30px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #00cec9;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00cec9;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error {
            text-align: center;
            padding: 50px;
            background: rgba(225, 112, 85, 0.2);
            border-radius: 10px;
            border: 1px solid #e17055;
            color: #e17055;
            margin: 20px auto;
            max-width: 500px;
        }

        /* æ— å¡ç‰ŒçŠ¶æ€ */
        .no-cards {
            text-align: center;
            padding: 50px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(108, 92, 231, 0.3);
            margin: 20px auto;
            max-width: 500px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .combine-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .combine-buttons {
                grid-template-columns: 1fr;
            }

            .combine-btn {
                width: 100%;
            }

            h1 {
                font-size: 1.8rem;
            }

            .back-button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <!-- è¿”å›æŒ‰é’® -->
    <a href="mycards.html" class="back-button">
        â† è¿”å›
    </a>

    <!-- åˆæˆç»“æœæ¨¡æ€æ¡† -->
    <div class="result-modal" id="resultModal">
        <div class="result-modal-content" id="resultModalContent">
            <!-- å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <div class="main-container">
        <div class="header">
            <h1>å¡ç‰Œåˆæˆ</h1>
            <p>é€‰æ‹©è¦åˆæˆçš„å¡ç‰Œæ˜Ÿçº§ï¼Œç‚¹å‡»å¡ç‰Œè¿›è¡Œé€‰æ‹©</p>
        </div>

        <!-- åˆæˆæŒ‰é’®åŒºåŸŸ -->
        <div class="combine-buttons">
            <button class="combine-btn rarity-1" data-rarity="1">1æ˜Ÿ â†’ 2æ˜Ÿ</button>
            <button class="combine-btn rarity-2" data-rarity="2">2æ˜Ÿ â†’ 3æ˜Ÿ</button>
            <button class="combine-btn rarity-3" data-rarity="3">3æ˜Ÿ â†’ 4æ˜Ÿ</button>
            <button class="combine-btn rarity-4" data-rarity="4">4æ˜Ÿ â†’ 5æ˜Ÿ</button>
            <button class="combine-btn rarity-5" data-rarity="5">5æ˜Ÿ â†’ 6æ˜Ÿ</button>
            <button class="combine-btn rarity-6" data-rarity="6">6æ˜Ÿ â†’ 7æ˜Ÿ</button>
        </div>

        <!-- é€‰æ‹©ç»Ÿè®¡ -->
        <div class="selection-info" id="selectionInfo" style="display: none;">
            <p>å·²é€‰æ‹© <span class="selected-count" id="selectedCount">0</span> å¼ å¡ç‰Œ</p>
        </div>

        <!-- å¡ç‰‡å±•ç¤ºåŒºåŸŸ -->
        <div class="cards-container" id="cardsContainer">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½å¯åˆæˆå¡ç‰Œ...</p>
            </div>

            <div class="error" id="error" style="display: none;"></div>

            <div class="no-cards" id="noCards" style="display: none;">
                <h2>æš‚æ— å¯åˆæˆå¡ç‰Œ</h2>
                <p>è¯·å…ˆæ”¶é›†è¶³å¤Ÿçš„ä½æ˜Ÿçº§å¡ç‰Œ</p>
            </div>
        </div>

        <!-- åˆæˆæŒ‰é’® -->
        <button class="execute-combine-btn" id="executeCombineBtn" disabled onclick="executeCombine()">
            å¼€å§‹åˆæˆ
        </button>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const $ = id => document.getElementById(id);
        const cardsContainer = $('cardsContainer');
        const loading = $('loading');
        const error = $('error');
        const noCards = $('noCards');
        const selectionInfo = $('selectionInfo');
        const selectedCount = $('selectedCount');
        const executeCombineBtn = $('executeCombineBtn');
        const resultModal = $('resultModal');
        const resultModalContent = $('resultModalContent');
        const combineButtons = document.querySelectorAll('.combine-btn');

        // å…¨å±€å˜é‡
        let currentRarityId = null;
        let selectedCards = []; // å­˜å‚¨é€‰æ‹©çš„card_global_id
        let allCardsData = null; // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„å¡ç‰‡æ•°æ®

        // ä¸ºæ¯ä¸ªåˆæˆæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        combineButtons.forEach(button => {
            button.addEventListener('click', () => {
                const rarityId = button.dataset.rarity;

                // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                clearSelection();

                // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                combineButtons.forEach(btn => btn.classList.remove('active'));
                // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                button.classList.add('active');

                // æ¸…ç©ºé€‰æ‹©
                clearSelection();
                fetchCombinableCards(rarityId);
            });
        });

        // è·å–å¯åˆæˆå¡ç‰Œ
        async function fetchCombinableCards(rarityId) {
            try {
                // è®¾ç½®å½“å‰ç¨€æœ‰åº¦
                currentRarityId = rarityId;

                // æ¸…ç©ºå·²é€‰æ‹©çš„å¡ç‰‡
                clearSelection();

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'block';
                error.style.display = 'none';
                noCards.style.display = 'none';
                selectionInfo.style.display = 'none';
                executeCombineBtn.disabled = true;

                // æ¸…é™¤ä¹‹å‰çš„å¡ç‰‡å±•ç¤º
                const existingPanels = document.querySelectorAll('.set-panel');
                existingPanels.forEach(panel => panel.remove());

                // å…³é—­ç»“æœæ¨¡æ€æ¡†
                const resultModal = $('resultModal');
                if (resultModal) {
                    resultModal.style.display = 'none';
                }

                // ä»localStorageè·å–cookie
                const cookie = localStorage.getItem('cookie');
                if (!cookie) {
                    showError('æœªæ‰¾åˆ°ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }

                const response = await fetch('/api/card/combine/view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cookie: cookie,
                        rarity_id: parseInt(rarityId)
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    allCardsData = data.data;
                    renderCombinableCards(data.data);
                } else {
                    showError('è·å–å¯åˆæˆå¡ç‰Œå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // æ¸²æŸ“å¯åˆæˆå¡ç‰Œ
        function renderCombinableCards(data) {
            if (!data.cards || data.cards.length === 0) {
                noCards.style.display = 'block';
                selectionInfo.style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºé€‰æ‹©ç»Ÿè®¡
            selectionInfo.style.display = 'block';
            updateSelectionCount();

            // æŒ‰set_nameåˆ†ç»„
            const sets = {};
            data.cards.forEach(card => {
                if (!sets[card.set_name]) {
                    sets[card.set_name] = [];
                }
                sets[card.set_name].push(card);
            });

            // åˆ›å»ºæ¯ä¸ªå¡ç»„çš„å±•ç¤ºé¢æ¿
            Object.entries(sets).forEach(([setName, cards]) => {
                const setPanel = document.createElement('div');
                setPanel.className = 'set-panel';

                // å¡ç»„å¤´éƒ¨
                const setHeader = document.createElement('h2');
                setHeader.className = 'set-header';
                setHeader.textContent = `${setName} (${cards.length}å¼ )`;

                // å¡ç‰‡ç½‘æ ¼
                const cardsGrid = document.createElement('div');
                cardsGrid.className = 'cards-grid';

                // æ·»åŠ æ¯å¼ å¡ç‰Œ
                cards.forEach(card => {
                    const cardItem = document.createElement('div');
                    cardItem.className = 'card-item';
                    cardItem.dataset.globalId = card.card_global_id;
                    cardItem.dataset.setName = card.set_name;

                    const imageUrl = `./images/${card.set_name}/${data.rarity_id}/${card.image_url}`;

                    cardItem.innerHTML = `
                        <div class="card-image" style="background-image: url('${imageUrl}')"></div>
                        <div class="card-info">
                            <div class="card-name">${card.card_name}</div>
                            <div class="card-global-id">${card.card_global_id}</div>
                        </div>
                    `;

                    // ç‚¹å‡»å¡ç‰‡è¿›è¡Œé€‰æ‹©
                    cardItem.addEventListener('click', () => {
                        toggleCardSelection(card.card_global_id, cardItem);
                    });

                    cardsGrid.appendChild(cardItem);
                });

                setPanel.appendChild(setHeader);
                setPanel.appendChild(cardsGrid);
                cardsContainer.insertBefore(setPanel, loading);
            });
        }

        // åˆ‡æ¢å¡ç‰‡é€‰æ‹©çŠ¶æ€
        function toggleCardSelection(cardGlobalId, cardElement) {
            const isSelected = selectedCards.includes(cardGlobalId);

            if (isSelected) {
                // å–æ¶ˆé€‰æ‹©
                selectedCards = selectedCards.filter(id => id !== cardGlobalId);
                cardElement.classList.remove('selected');
            } else {
                // é€‰æ‹©
                selectedCards.push(cardGlobalId);
                cardElement.classList.add('selected');
            }

            // æ›´æ–°é€‰æ‹©ç»Ÿè®¡
            updateSelectionCount();

            // æ›´æ–°åˆæˆæŒ‰é’®çŠ¶æ€
            executeCombineBtn.disabled = selectedCards.length === 0;
        }

        // æ›´æ–°é€‰æ‹©ç»Ÿè®¡
        function updateSelectionCount() {
            selectedCount.textContent = selectedCards.length;
        }

        // æ¸…ç©ºé€‰æ‹©
        function clearSelection() {
            selectedCards = [];

            // ç§»é™¤é€‰ä¸­æ ·å¼
            document.querySelectorAll('.card-item').forEach(card => {
                card.classList.remove('selected');
            });

            // é‡ç½®é€‰æ‹©ç»Ÿè®¡
            if (selectedCount) {
                selectedCount.textContent = '0';
            }

            // éšè—é€‰æ‹©ç»Ÿè®¡åŒºåŸŸ
            if (selectionInfo) {
                selectionInfo.style.display = 'none';
            }

            // ç¦ç”¨åˆæˆæŒ‰é’®
            if (executeCombineBtn) {
                executeCombineBtn.disabled = true;
            }
        }

        // æ‰§è¡Œåˆæˆ
        async function executeCombine() {
            if (!currentRarityId || selectedCards.length === 0) {
                showError('è¯·å…ˆé€‰æ‹©å¡ç‰Œ');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'block';
                executeCombineBtn.disabled = true;
                executeCombineBtn.textContent = 'åˆæˆä¸­...';

                // ä»localStorageè·å–cookie
                const cookie = localStorage.getItem('cookie');
                if (!cookie) {
                    showError('æœªæ‰¾åˆ°ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }

                const response = await fetch('/api/card/combine/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cookie: cookie,
                        cards: selectedCards,
                        rarity_id: parseInt(currentRarityId)
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // æ¸…ç©ºå·²é€‰æ‹©çš„å¡ç‰‡
                    clearSelection();
                    // åˆæˆæˆåŠŸï¼Œåˆ·æ–°å¡ç‰Œåˆ—è¡¨
                    await fetchCombinableCards(currentRarityId);

                    // æ˜¾ç¤ºåˆæˆç»“æœæ¨¡æ€æ¡†
                    showCombineResultModal(data.data);
                } else {
                    showError('åˆæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message);
            } finally {
                loading.style.display = 'none';
                executeCombineBtn.disabled = false;
                executeCombineBtn.textContent = 'å¼€å§‹åˆæˆ';
            }
        }

        // æ˜¾ç¤ºåˆæˆç»“æœæ¨¡æ€æ¡†
        function showCombineResultModal(data) {
            const resultModal = $('resultModal');
            const resultModalContent = $('resultModalContent');

            // åœ¨æ˜¾ç¤ºæ¨¡æ€æ¡†å‰ï¼Œç¡®ä¿å·²æ¸…ç©ºé€‰æ‹©
            clearSelection();

            // æ„å»ºç»“æœHTML
            let resultHTML = `
                <div class="result-modal-header">
                    <div class="result-modal-success-icon">ğŸ‰</div>
                    <h2 class="result-modal-title">åˆæˆæˆåŠŸï¼</h2>
                </div>
                
                <div class="result-modal-info">
                    <div class="result-info-section">
                        <div class="result-info-label">æ¶ˆè€—å¡ç‰Œ</div>
                        <div class="result-info-value">${data.input_info.count}å¼ </div>
                        <div class="result-info-label">æ¶ˆè€—ç¨€æœ‰åº¦</div>
                        <div class="result-info-value">${data.input_info.rarity_id}æ˜Ÿ</div>
                    </div>
                    
                    <div class="result-info-section">
                        <div class="result-info-label">è·å¾—ç¨€æœ‰åº¦</div>
                        <div class="result-info-value">${data.output_info.rarity_id}æ˜Ÿ</div>
                        <div class="result-info-label">è·å¾—å¡ç‰Œæ•°</div>
                        <div class="result-info-value">${data.output_info.cards_generated}å¼ </div>
                    </div>
                    
                    <div class="result-info-section">
                        <div class="result-info-label">åˆæˆå¥—ç³»</div>
                        <div class="result-info-value">${data.set_info.set_name}</div>
                        <div class="result-info-label">åˆæˆæ¯”ä¾‹</div>
                        <div class="result-info-value">${data.input_info.count}:${data.output_info.cards_generated}</div>
                    </div>
                </div>
                
                <div class="consumed-cards-section">
                    <h3 class="consumed-header">æ¶ˆè€—çš„å¡ç‰Œï¼š</h3>
                    <div class="consumed-list">
            `;

            // æ·»åŠ æ¶ˆè€—çš„å¡ç‰Œ
            data.input_info.cards_consumed.forEach(cardId => {
                resultHTML += `<span class="consumed-id">${cardId}</span>`;
            });

            resultHTML += `
                    </div>
                </div>
                
                <h3 style="color: #00b894; margin-bottom: 15px;">è·å¾—çš„æ–°å¡ç‰Œï¼š</h3>
                <div class="result-modal-cards">
            `;

            // æ·»åŠ è·å¾—çš„æ–°å¡ç‰Œ
            data.output_info.cards.forEach(card => {
                const imageUrl = `./images/${data.set_info.set_name}/${data.output_info.rarity_id}/${card.image_url}`;
                resultHTML += `
                    <div class="result-card">
                        <div class="result-card-image" style="background-image: url('${imageUrl}')"></div>
                        <div class="result-card-info">
                            <div class="result-card-name">${card.card_name}</div>
                            <div class="result-card-id">${card.card_global_id}</div>
                        </div>
                    </div>
                `;
            });

            resultHTML += `
                </div>
                
                <div class="result-modal-actions">
                    <button class="modal-close-btn" onclick="closeResultModal()">ç¡®è®¤</button>
                </div>
            `;

            resultModalContent.innerHTML = resultHTML;
            resultModal.style.display = 'flex';
        }

        // å…³é—­ç»“æœæ¨¡æ€æ¡†
        function closeResultModal() {
            const resultModal = $('resultModal');
            resultModal.style.display = 'none';

            // ç¡®ä¿æ¸…ç©ºé€‰æ‹©
            clearSelection();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) {
                closeResultModal();
            }
        });

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            error.style.display = 'block';
            error.innerHTML = `
                <p>${message}</p>
                <button onclick="window.location.reload()" style="
                    padding: 10px 20px;
                    margin-top: 20px;
                    background: linear-gradient(45deg, #6c5ce7, #a29bfe);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: 600;
                ">é‡æ–°åŠ è½½</button>
            `;
        }
    </script>
</body>

</html>